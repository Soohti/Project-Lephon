name: Build and Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release (e.g. v1.2.3)'
        required: true
      release_name:
        description: 'Release title (defaults to tag if empty)'
        required: false
        default: ''
      body:
        description: 'Release notes (supports Markdown)'
        required: false
        default: ''
      draft:
        description: 'Create as a draft release?'
        required: true
        default: 'false'
        type: boolean
      prerelease:
        description: 'Mark as a prerelease?'
        required: true
        default: 'false'
        type: boolean

defaults:
  run:
    shell: bash

jobs:
  build-mac:
    name: Build for macOS
    runs-on: macos-latest

    steps:
      - name: Checkout project code
        uses: actions/checkout@v4
        with:
          path: source_code

      - name: Setup openFrameworks and Addons
        run: |
          echo "Downloading and setting up openFrameworks v0.12.0..."
          curl -L -O https://github.com/openframeworks/openFrameworks/releases/download/0.12.0/of_v0.12.0_osx_release.zip
          unzip -q of_v0.12.0_osx_release.zip
          mv of_v0.12.0_osx_release openframeworks
          
          echo "Cloning required addons..."
          cd openframeworks/addons
          git clone https://github.com/kylemcdonald/ofxCv.git

      - name: Move Project and Compile
        working-directory: ./openframeworks
        run: |
          echo "Moving project into openFrameworks apps folder..."
          mkdir -p apps/myApps
          mv ../source_code ./apps/myApps/Project\ Lephon

          echo "Compiling project with xcodebuild..."
          cd ./apps/myApps/Project\ Lephon
          xcodebuild -project "Project Lephon.xcodeproj" -scheme "Project Lephon Release" -configuration Release build

      - name: Package macOS App
        run: |
          echo "Packaging the application and resources..."
          cd openframeworks/apps/myApps/Project\ Lephon/bin
          zip -r "${{ github.workspace }}/Project-Lephon-macOS.zip" .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: Project-Lephon-macOS.zip

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-mac]
    permissions:
      contents: write # Required to create releases

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        uses: actions/create-release@v1
        id: create_release
        with:
          tag_name: ${{ github.event.inputs.tag }}
          release_name: ${{ github.event.inputs.release_name || github.event.inputs.tag }}
          body: ${{ github.event.inputs.body }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/macos-build/Project-Lephon-macOS.zip
          asset_name: Project-Lephon-macOS.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
